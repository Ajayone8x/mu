<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shaka Stream Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://ajax.googleapis.com/ajax/libs/shaka-player/4.3.4/shaka-player.ui.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/shaka-player/4.3.4/controls.css">
    
    <style>
        body {
            height: 100svh;
            display: flex;
            flex-direction: column;
            background-color: #02040a;
            font-family: 'Inter', sans-serif;
            color: white;
            overflow: hidden;
        }
        .player-main {
            flex-grow: 1;
            background-color: #000;
            min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        :root {
            --shaka-controls-button-color: white;
            --shaka-controls-color: white;
            --shaka-controls-icon-color: white;
            --shaka-range-track-color: rgba(255, 255, 255, 0.3);
            --shaka-range-thumb-color: #0ea5e9;
            --shaka-range-fill-color: #0ea5e9;
        }
        .error-message { text-align: center; padding: 2rem; }
    </style>
</head>
<body>
    <header class="flex-shrink-0 p-4 bg-slate-900 border-b border-slate-700 flex items-center justify-between">
        <div class="flex items-center min-w-0">
            <img id="channel-logo" src="" class="h-8 w-8 mr-3 rounded-full bg-slate-700" alt="logo">
            <h1 id="channel-name-header" class="text-lg font-bold truncate">Loading...</h1>
        </div>
        <a href="index.html" class="px-4 py-2 bg-sky-600 rounded-lg font-semibold hover:bg-sky-500 transition-colors">
            Back
        </a>
    </header>

    <main class="player-main">
        <div data-shaka-player-container style="width: 100%; height: 100%;">
            <video autoplay data-shaka-player id="player" style="width:100%; height:100%;"></video>
        </div>
    </main>

    <script>
        const playerElement = document.getElementById('player');
        const channelNameHeader = document.getElementById('channel-name-header');
        const channelLogo = document.getElementById('channel-logo');
        const mainContent = document.querySelector('.player-main');

        async function initPlayer() {
            const params = new URLSearchParams(window.location.search);
            const streamUrl = params.get('streamUrl');
            const licenseUrl = params.get('licenseUrl');
            const name = params.get('name');
            const logo = params.get('logo');

            if (!streamUrl || !licenseUrl) {
                showError("Error: Stream URL or License URL is missing.");
                return;
            }

            channelNameHeader.textContent = name || 'Live Stream';
            channelLogo.src = logo || '';

            const player = new shaka.Player(playerElement);
            
            // --- PLAYER FIX STARTS HERE ---
            // This logic modifies the license request to add the specific headers 
            // required by this particular stream provider.
            player.getNetworkingEngine().registerRequestFilter((type, request) => {
                // We only want to modify license requests.
                if (type === shaka.net.NetworkingEngine.RequestType.LICENSE) {
                    
                    // 1. Extract the deviceId from the license URL.
                    const url = new URL(request.uris[0]);
                    const deviceId = url.searchParams.get('deviceId');

                    // 2. Add the specific header the DRM provider expects.
                    // This is the most critical part of the fix.
                    if (deviceId) {
                        request.headers['dt-custom-data'] = deviceId;
                    }

                    // 3. Ensure the request method is POST.
                    request.method = 'POST';
                    
                    // 4. Set the correct Content-Type for the raw license challenge.
                    request.headers['Content-Type'] = 'application/octet-stream';
                }
            });
            // --- PLAYER FIX ENDS HERE ---

            player.configure({
                drm: {
                    servers: { 'com.widevine.alpha': licenseUrl }
                }
            });

            player.addEventListener('error', onErrorEvent);

            try {
                await player.load(streamUrl);
                console.log('The video has now been loaded!');
            } catch (e) {
                onError(e);
            }
        }

        function showError(message) {
             mainContent.innerHTML = `<div class="error-message"><h2 class="text-2xl font-bold text-red-500 mb-4">Playback Error</h2><p class="text-slate-400">${message}</p></div>`;
        }

        function onErrorEvent(event) {
            onError(event.detail);
        }

        function onError(error) {
            console.error('Shaka Player Error:', error.code, 'Object', error);
            showError(`<b>Error Code:</b> ${error.code}<br>Could not play the protected content. This might be due to a browser limitation, an invalid license key, or a network issue.`);
        }
        
        document.addEventListener('shaka-ui-loaded', initPlayer);
    </script>
</body>
</html>
